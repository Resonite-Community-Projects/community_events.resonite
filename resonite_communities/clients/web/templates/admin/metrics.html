{% extends "admin/base.html" %}
    {% block alpine_components_head %}
    <script defer src="/static/js/alpine/pages/admin_metrics.js"></script>
    {% endblock %}
    {% block extended_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        .chart-container, .pie-chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 30px;
        }
        .pie-chart-container {
            height: 200px;
        }
        .metrics-card {
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .metric-box {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
        }

    </style>
    {% endblock %}
    {% block content %}

    <div x-data="metricsPage()" class="fixed-grid has-1-cols">
        <div class="grid">

            <div class="fixed-grid has-4-cols">
                <div class="grid">
                    <div class="cell"></div>
                    <div class="cell">
                        <div class="card has-text-centered">
                            <div class="card-content">
                                <p class="title">Today Users Average</p>
                                <div class="content is-size-3">
                                    <p x-text="usersAverageCounterData?.average_unique_users ? Math.round(usersAverageCounterData.average_unique_users) : '-'"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="cell">
                        <div class="card has-text-centered">
                            <div class="card-content">
                                <p class="title">Yesterday Users Average</p>
                                <div class="content is-size-3">
                                    <p x-text="usersAverageCounterData?.last_day_unique_users ? Math.round(usersAverageCounterData.last_day_unique_users) : '-'"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="cell"></div>
                </div>
            </div>

                <div class="card metrics-card">
                    <div class="card-content">
                        <p class="title has-text-centered">World Map (Daily Unique Users)</p>
                        <div class="content">
                            <div id="regions_div" style="width: 900px; height: 500px; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>

            <!-- Daily Unique Users Chart -->
            <div class="card metrics-card">
                <div class="card-content">
                    <p class="title has-text-centered">Weekly Unique Users</p>
                    <div class="content">
                        <div id="daily-users-chart" class="chart-container">
                            <!-- Daily Unique Users Chart will be inserted here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Activity Heatmap -->
            <div class="card metrics-card">
                <div class="card-content">
                    <p class="title has-text-centered">User Activity by Day and Hour</p>
                    <p class="subtitle has-text-centered">Optimal maintenance window appears in lighter colors</p>
                    <div class="content">
                        <div x-show="loadingHeatmap" class="has-text-centered py-5">
                            <p class="is-size-5">Loading heatmap...</p>
                        </div>
                        <div x-show="!loadingHeatmap && heatmapData" id="activity-heatmap" class="chart-container">
                            <!-- User Activity Heatmap will be inserted here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

    <!-- Client Type Distribution Chart -->
    <div class="card metrics-card">
        <div class="card-content">
            <p class="title has-text-centered">Client Types Distribution</p>
            <div class="content">
                <div x-show="loadingClientTypes" class="has-text-centered py-5">
                    <p class="is-size-5">Loading client types...</p>
                </div>
                <div x-show="!loadingClientTypes && clientTypeData" class="columns">
                    <div class="column is-5">
                        <div id="client-type-chart-container" class="chart-container pie-chart-container">
                            <!-- Client Type Distribution Chart will be inserted here dynamically -->
                        </div>
                    </div>
                    <div class="column is-7">
                        <table class="table is-fullwidth">
                            <thead>
                                <tr>
                                    <th>Client Type</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="clientType in clientTypeData || []">
                                    <tr>
                                        <td x-text="clientType.client || 'Unknown'"></td>
                                        <td x-text="clientType.count"></td>
                                        <td x-text="getClientTypePercentage(clientType) + '%'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version Distribution Chart -->
    <div class="card metrics-card">
        <div class="card-content">
            <p class="title has-text-centered">Client Versions</p>
            <div class="content">
                <div class="columns">
                    <div class="column is-5">
                        <div id="version-chart-container" class="chart-container pie-chart-container">
                            <!-- Version Distribution Chart will be inserted here dynamically -->
                        </div>
                    </div>
                    <div class="column is-7">
                        <table class="table is-fullwidth">
                            <thead>
                                <tr>
                                    <th>Version</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="version in versionChartData?.versions || []">
                                    <tr>
                                        <td x-text="version.version || 'Unknown'"></td>
                                        <td x-text="version.count"></td>
                                        <td x-text="getVersionPercentage(version) + '%'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Domain Activity -->
    <div id="domain-charts-container">
        <template x-for="(entry, index) in Object.entries(domainData || {})" :key="entry[0]">
            <div class="card metrics-card">
                <div class="card-content">
                    <p class="title has-text-centered" x-text="`${entry[0]} (${entry[1].total_counts})`"></p>
                    <div class="content">
                        <div class="columns">
                            <div class="column is-5">
                                <div :id="`domain-chart-${entry[0].replace(/\./g, '-')}`" class="chart-container pie-chart-container">
                                    <!-- Domain Activity Chart will be inserted here dynamically -->
                                </div>
                            </div>
                            <div class="column is-7">
                                <table class="table is-fullwidth">
                                    <thead>
                                        <tr>
                                            <th>Endpoint</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="metric in entry[1].counts" :key="metric.endpoint">
                                            <tr>
                                                <td x-text="metric.endpoint"></td>
                                                <td x-text="metric.count"></td>
                                                <td x-text="getDomainPercentage(metric.count, entry[1].total_counts) + '%'"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    {% endblock %}
